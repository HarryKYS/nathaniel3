
%sandbox4

with cp as 
(
	select 
	ri.invoicenumber
	, rt.acceptancestatus 
	, rl.trackingstatus 
	, rl.lasttrackingupdatedat 	
	, ROW_NUMBER() OVER(partition by ri.invoicenumber ORDER BY rl.lasttrackingupdatedat desc) as rn
	from 
	ods.returns rt
	INNER JOIN ods.return_invoices ri on ri.returnid = rt.returnid -- and ri.trackingstatus in ('RETURN_CAMP_ARRIVED')
	INNER JOIN ods.return_invoice_logs rl on rl.returninvoiceid = ri.returninvoiceid and rl.trackingstatus in ('RETURN_CAMP_ARRIVED')
	-- where ri.invoicenumber ='993196193883'
	where date(rl.lasttrackingupdatedat) >= date('${from_dt}') -- and  ri.invoicenumber ='993196193883'
	group by 1,2,3,4
)
, ct as 
(
	select 
	ri.invoicenumber
	, rt.acceptancestatus 
	, rl.trackingstatus
	, rl.lasttrackingupdatedat 	
	, ROW_NUMBER() OVER(partition by ri.invoicenumber ORDER BY rl.lasttrackingupdatedat desc) as rn
	from 
	ods.returns rt
	INNER JOIN ods.return_invoices ri on ri.returnid = rt.returnid  and ri.trackingstatus in ('RETURN_CENTER_LOADED')
	INNER JOIN ods.return_invoice_logs rl on rl.returninvoiceid = ri.returninvoiceid  and rl.trackingstatus in ('RETURN_CENTER_LOADED')
	-- where ri.invoicenumber ='993196193883'
	where date(rl.lasttrackingupdatedat) >= date('${from_dt}')  -- and ri.invoicenumber ='993196193883'
	group by 1,2,3,4
)
, uni as 
(
	select
	date(a.lasttrackingupdatedat) as dt 
	, case when b.acceptancestatus is not null then b.acceptancestatus else a.acceptancestatus end as acceptancestatus
	, a.invoicenumber as return_invoicenumber
	, case when b.trackingstatus is not null then b.trackingstatus else a.trackingstatus end as 반품상태
	, case when a.lasttrackingupdatedat is not null then a.lasttrackingupdatedat else null end as 캠프도착완료
	, case when b.lasttrackingupdatedat is not null then b.lasttrackingupdatedat else null end as 센터상차완료
	from 
	cp as a 
	left join ct b on a.invoicenumber=b.invoicenumber and b.rn=1
	where a.rn=1 -- and a.invoicenumber ='993196193883'
)
, col as 
(
	select 
	ri.invoicenumber 
	, rl.lasttrackingupdatedat
	, rl.workerid
	, rw.walkmanid
	, rt.campid 
	, ROW_NUMBER() OVER(partition by ri.invoicenumber ORDER BY rl.lasttrackingupdatedat desc) as rn
	from 
	ods.returns rt
	INNER JOIN ods.return_invoices ri on ri.returnid = rt.returnid -- and ri.trackingstatus in ('RETURN_CAMP_ARRIVED')
	INNER JOIN ods.return_invoice_logs rl on rl.returninvoiceid = ri.returninvoiceid  and rl.trackingstatus  in ('RETURN_COLLECTED')
	LEFT JOIN ods.return_walkman_logs rw ON rw.returninvoicelogid = rl.returninvoicelogid
	where date(rl.lasttrackingupdatedat) >= date('${from_dt}')-100
	group by 1,2,3,4,5
)
select
distinct uni.dt
, c.region 
, c.area
, c.camp
, uni.return_invoicenumber
, col.lasttrackingupdatedat as 회수완료처리시각
, uni.캠프도착완료
, uni.센터상차완료
, case when cf.tmsloginid is not null then cf.tmsloginid else u.loginid end as tmsloginid
, case when cf.tmsloginid is not null then cf.flex_type else 'CPF' end as WORKER_TYPE
from 
uni uni
left join col col on col.invoicenumber=uni.return_invoicenumber and col.rn=1
left join bimart.dtd_camp dc on dc.camp_id =col.campid
left join sb_logistics.campregion c on c.camp = dc.camp_english_name
join ods.users u on u.userid = col.workerid 
left join ods.users u2 on u2.userid = col.walkmanid
left join sb_logistics.flex_delivery_user_histories cf on cf.workdate = date(col.lasttrackingupdatedat) and u2.loginid = cf.tmsloginid
where date(uni.dt) between date('${from_dt}') and date('${to_dt}') and c.camp in ('GUR_2','NYJ_3')
order by 1,2,3,4,5,6,7
;


